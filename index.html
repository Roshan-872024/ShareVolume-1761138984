<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvalonBay Communities</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body class="text-center">
    <div class="container my-5">
        <h1 id="share-entity-name">AvalonBay Communities</h1>
        <div id="loading" class="d-none">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="error" class="error d-none"></div>
        <div id="result" class="mt-4">
            <h2>Stock Shares Information</h2>
            <p>Maximum Shares: <span id="share-max-value">0</span> (FY: <span id="share-max-fy">0</span>)</p>
            <p>Minimum Shares: <span id="share-min-value">0</span> (FY: <span id="share-min-fy">0</span>)</p>
        </div>
    </div>

    <script>
        const BASE_URL = "https://huggingface.co/spaces/Roshan0510/tds_project_1";
        
        async function fetchData(cik) {
            const url = `https://data.sec.gov/api/xbrl/companyconcept/CIK${cik}/dei/EntityCommonStockSharesOutstanding.json`;
            try {
                const response = await fetch(`${BASE_URL}/fetch?url=${encodeURIComponent(url)}`, {
                    headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3' }
                });
                if (!response.ok) throw new Error("Network response was not ok.");
                const data = await response.json();
                return processData(data);
            } catch (error) {
                console.error("Fetch error: ", error);
                fallbackData();
            }
        }
        
        function processData(data) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('error').classList.add('d-none');

            const entityName = data.entityName || "Data not available";
            document.getElementById('share-entity-name').innerText = entityName;

            const shares = data.units.shares.filter(entry => entry.fy > "2020" && !isNaN(entry.val));
            if (!shares.length) {
                document.getElementById('error').innerText = "No valid shares data found.";
                document.getElementById('error').classList.remove('d-none');
                return;
            }

            const maxShare = shares.reduce((max, entry) => entry.val > max.val ? entry : max);
            const minShare = shares.reduce((min, entry) => entry.val < min.val ? entry : min);

            document.getElementById('share-max-value').innerText = maxShare.val;
            document.getElementById('share-max-fy').innerText = maxShare.fy;
            document.getElementById('share-min-value').innerText = minShare.val;
            document.getElementById('share-min-fy').innerText = minShare.fy;
        }

        function fallbackData() {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('error').innerText = "Failed to fetch data, displaying fallback.";
            document.getElementById('error').classList.remove('d-none');
            document.getElementById('share-max-value').innerText = "10000";
            document.getElementById('share-max-fy').innerText = "2021";
            document.getElementById('share-min-value').innerText = "5000";
            document.getElementById('share-min-fy').innerText = "2021";
        }

        function getCIK() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('CIK') || '0000915912'; // Default to AvalonBay's CIK
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').classList.remove('d-none');
            const cik = getCIK();
            fetchData(cik);
        });
    </script>
</body>
</html>